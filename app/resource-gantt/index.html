<html>
<head>
    <style>
        #chartdiv {
            width: 100%;
            height: 95%;
        }
    </style>
    <link rel="stylesheet" href="/amcharts/plugins/export/export.css" type="text/css" media="all"/>
    <link rel="stylesheet" href="/bootstrap/css/bootstrap.min.css" type="text/css" media="all"/>
    <link rel="stylesheet" href="/bootstrap/css/bootstrap-theme.min.css" type="text/css" media="all"/>
    <link rel="stylesheet" href="/static/css/style.css" type="text/css" media="all"/>
</head>

<body>
<nav class="navbar navbar-default navbar-fixed-top">
    <div class="container-fluid">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-togle="collapse" data-target="#navbar"
                    aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Quali Utilities</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li><a href="/resource-gantt/index.html">Resource Gantt</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
            </ul>
        </div>
    </div>
</nav>
<div class="container-fluid">
    <div class="row">
        <div class="col-xs-12 ng-view">
            <div id="filter">
                <label>
                    Search:
                    <input id="filter-resource" type="text" onchange="applyFilters()"/>
                </label>
            </div>
            <div id="chartdiv">
            </div>
        </div>
    </div>
</div>
<script src="/amcharts/amcharts.js"></script>
<script src="/amcharts/serial.js"></script>
<script src="/amcharts/gantt.js"></script>
<script src="/amcharts/plugins/export/export.min.js"></script>
<script src="/amcharts/themes/light.js"></script>
<script>
    function getQueryParams(qs) {
        qs = qs.split('+').join(' ');

        var params = {},
            tokens,
            re = /[?&]?([^=]+)=([^&]*)/g;

        while (tokens = re.exec(qs)) {
            params[decodeURIComponent(tokens[1])] = decodeURIComponent(tokens[2]);
        }

        return params;
    }

    function insertParam(key, value) {
        key = encodeURI(key);
        value = encodeURI(value);

        var kvp = null

        queryParamString = document.location.search.substr(1);

        if (queryParamString) {
            kvp = document.location.search.substr(1).split('&');
        }
        else {
            kvp = [];
        }
        console.log(kvp);

        var i = kvp.length;
        var x;
        while (i--) {
            x = kvp[i].split('=');

            if (x[0] == key) {
                x[1] = value;
                kvp[i] = x.join('=');
                break;
            }
        }

        if (i < 0) {
            kvp[kvp.length] = [key, value].join('=');
        }

        document.location.search = kvp.join('&');
    }

    function xhrError() {
        console.error(this.statusText);
    }

    function loadJSON(file) {
        var request;

        if (window.XMLHttpRequest) {
            // IE7+, Firefox, Chrome, Opera, Safari
            request = new XMLHttpRequest();
            request.onerror = xhrError;
        } else {
            // code for IE6, IE5
            request = new ActiveXObject('Microsoft.XMLHTTP');
        }
        request.open('GET', file, false);
        request.send(null);

        return eval(request.responseText);
    }

    var dataSource = loadJSON("/data/resource-gantt-reservations.json");

    function containsAny(str, substrings) {
        for (var i = 0; i != substrings.length; i++) {
            var substring = substrings[i];
            if (str.indexOf(substring) != -1) {
                return true;
            }
        }

        return false;
    }

    function getFilteredData() {
        var filteredData = [];
        var resourceSearch = null;

        filterResource = document.getElementById("filter-resource").value;

        if (!filterResource) {
            resourceSearch = getQueryParams(document.location.search).search;
            if (resourceSearch) {
                filterResource.value = resourceSearch;
                document.getElementById("filter-resource").value = resourceSearch;
            }
            else {
                resourceSearch = ""
            }
        }
        else {
            var resourceSearch = filterResource;
        }

        resourceSearch = resourceSearch.toLowerCase().replace(/\s/g, '').split(',');
        for (var i = 0; i < dataSource.length; i++) {
            var dataPoint = dataSource[i];

            if (containsAny(dataPoint.category.toLowerCase(), resourceSearch)) {
                filteredData.push(dataPoint);
            }
        }

        return filteredData;
    }

    function applyFilters() {
        if (!document.getElementById("filter-resource")) {
            var query = getQueryParams(document.location.search)
        }
        else {
            insertParam(
                'search',
                document.getElementById("filter-resource").value
                    .toLowerCase()
                    .replace(/\s/g, '')
                    .split(','));
        }

        chart.dataProvider = getFilteredData();
        chart.validateData();
    }

    var chart = AmCharts.makeChart("chartdiv", {
        "type": "gantt",
        "theme": "dark",
        "marginRight": 70,
        "period": "hh",
        "dataDateFormat": "YYYY-MM-DD JJ:NN",
        "balloonDateFormat": "YYYY-MM-DD JJ",
        "columnWidth": 0.5,
        "valueAxis": {
            "type": "date"
        },
        "graph": {
            "lineAlpha": 1,
            "lineColor": "#000",
            "fillAlphas": 0.85,
            "balloonText": "<b>[[task]]</b><br/>[[start]] - [[end]]"
        },
        "rotate": true,
        "categoryField": "category",
        "segmentsField": "segments",
        "colorField": "color",
        "startDateField": "start",
        "endDateField": "end",
        "dataProvider": getFilteredData(),
        "valueScrollbar": {
            "autoGridCount": true,
            "backgroundColor": "#EFEFEF",
		    "selectedBackgroundColor": "#000000",
        },
        "chartCursor": {
            "cursorColor": "#55bb76",
            "valueBalloonsEnabled": false,
            "cursorAlpha": 0,
            "valueLineAlpha": 0.5,
            "valueLineBalloonEnabled": true,
            "valueLineEnabled": true,
            "zoomable": false,
            "valueZoomable": true
        },
        "export": {
            "enabled": true,
            "libs": {
                "path": "/amcharts/plugins/export/libs/"
            }
        },
        "listeners": [{
            "event": "rollOverGraphItem",
            "method": function (event) {
                changeStroke(event, 5);
            }
        }, {
            "event": "rollOutGraphItem",
            "method": function (event) {
                changeStroke(event, 1);
            }
        }]
    });

    function changeStroke(event, strokeWidth) {
        var elements = event.item.columnGraphics.node.getElementsByTagName("path");
        for (var i = 0; i < elements.length; i++) {
            elements[i].setAttribute("stroke-width", strokeWidth);
        }
    }


</script>
</body>
</html>